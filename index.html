<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACIv2 API - Documentación</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="sidebar">
        <div class="logo">
            <h2>ACIv2 API</h2>
            <p class="version">v2.0</p>
        </div>
        
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Buscar endpoints...">
        </div>

        <ul class="nav-menu">
            <li><a href="#introduccion" class="active">Introducción</a></li>
            <li><a href="#autenticacion">Autenticación</a></li>
            <li>
                <a href="#quickbooks">QuickBooks</a>
                <ul class="submenu">
                    <li><a href="#qb-auth">Autorización</a></li>
                    <li><a href="#qb-invoices">Facturas</a></li>
                    <li><a href="#qb-webhooks">Webhooks</a></li>
                    <li><a href="#qb-maintenance">Mantenimiento</a></li>
                </ul>
            </li>
            <li>
                <a href="#zoho">Zoho</a>
                <ul class="submenu">
                    <li><a href="#zoho-auth">Autorización</a></li>
                    <li><a href="#zoho-invoices">Facturas</a></li>
                    <li><a href="#zoho-credits">Notas de Crédito</a></li>
                </ul>
            </li>
            <li>
                <a href="#xero">Xero</a>
                <ul class="submenu">
                    <li><a href="#xero-auth">Autorización</a></li>
                    <li><a href="#xero-invoices">Facturas</a></li>
                </ul>
            </li>
            <li>
                <a href="#shopify">Shopify</a>
                <ul class="submenu">
                    <li><a href="#shopify-auth">Autorización</a></li>
                    <li><a href="#shopify-orders">Órdenes</a></li>
                    <li><a href="#shopify-emit">Emisión</a></li>
                    <li><a href="#shopify-webhooks">Webhooks</a></li>
                </ul>
            </li>
            <li><a href="#woocommerce">WooCommerce</a></li>
            <li><a href="#dentalink">Dentalink</a></li>
            <li><a href="#utilidades">Utilidades y Catálogos</a></li>
            <li><a href="#administracion">Administración</a></li>
            <li><a href="#errores">Códigos de Error</a></li>
            <li><a href="#mejores-practicas">Mejores Prácticas</a></li>
        </ul>
    </nav>

    <main class="content">
        <section id="introduccion" class="section active">
            <h1>Documentación ACIv2 API</h1>
            <p class="lead">API de integración para facturación electrónica con múltiples plataformas</p>
            
            <div class="info-box info">
                <h3>Acerca de esta API</h3>
                <p>ACIv2 es una API basada en Firebase Functions que proporciona integración con múltiples plataformas de gestión empresarial para la emisión de facturas electrónicas en Panamá.</p>
            </div>

            <h2>Plataformas Soportadas</h2>
            <div class="platform-grid">
                <div class="platform-card">
                    <h3>QuickBooks</h3>
                    <p>Sistema de contabilidad y gestión empresarial</p>
                </div>
                <div class="platform-card">
                    <h3>Zoho</h3>
                    <p>Suite de gestión empresarial</p>
                </div>
                <div class="platform-card">
                    <h3>Xero</h3>
                    <p>Software de contabilidad en la nube</p>
                </div>
                <div class="platform-card">
                    <h3>Shopify</h3>
                    <p>Plataforma de comercio electrónico</p>
                </div>
                <div class="platform-card">
                    <h3>WooCommerce</h3>
                    <p>Plugin de tienda para WordPress</p>
                </div>
                <div class="platform-card">
                    <h3>Dentalink</h3>
                    <p>Sistema de gestión dental</p>
                </div>
            </div>

            <h2>Características Principales</h2>
            <ul class="feature-list">
                <li>Autenticación mediante JWT o Basic Auth</li>
                <li>Procesamiento asíncrono de webhooks con sistema de colas (Redis + Bee-Queue)</li>
                <li>Integración con PAC (Proveedor Autorizado de Certificación) para facturación electrónica</li>
                <li>Validación automática de RUC, DV y datos fiscales</li>
                <li>Sincronización bidireccional de facturas y clientes</li>
                <li>Sistema de reintentos y recuperación de errores</li>
            </ul>

            <h2>Base URL</h2>
            <div class="code-block">
                <code>https://us-central1-[proyecto].cloudfunctions.net/aciv2</code>
            </div>
        </section>

        <section id="autenticacion" class="section">
            <h1>Autenticación</h1>
            <p>La API soporta dos métodos de autenticación:</p>

            <h2>1. Basic Authentication</h2>
            <p>Utiliza el header <code>Authorization</code> con credenciales codificadas en Base64:</p>
            <div class="code-block">
                <pre><code>Authorization: Basic base64(email:password)</code></pre>
            </div>

            <div class="info-box warning">
                <h3>Importante</h3>
                <p>Las credenciales se validan contra Firebase Authentication. En el primer acceso, se genera y almacena un token de sesión en Firestore.</p>
            </div>

            <h2>2. JWT Token</h2>
            <p>Utiliza un token JWT firmado con RS256:</p>
            <div class="code-block">
                <pre><code>Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...</code></pre>
            </div>

            <p>También se puede enviar como parámetro de query:</p>
            <div class="code-block">
                <pre><code>GET /endpoint?token=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...</code></pre>
            </div>

            <h3>Ejemplo de Autenticación con cURL</h3>
            <div class="code-block">
                <pre><code>curl -X GET "https://[base-url]/quickbooks/invoices" \
  -H "Authorization: Basic $(echo -n 'user@example.com:password' | base64)"</code></pre>
            </div>
        </section>

        <section id="quickbooks" class="section">
            <h1>QuickBooks API</h1>
            <p>Endpoints para integración con QuickBooks Online.</p>

            <h2 id="qb-auth">Autorización</h2>
            
            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/quickbooks/authorization_url</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene la URL de autorización de QuickBooks OAuth2.</p>
                    <h4>Respuesta</h4>
                    <div class="code-block">
                        <pre><code>{
  "authUri": "https://appcenter.intuit.com/connect/oauth2?...",
  "state": "random-state-string"
}</code></pre>
                    </div>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/quickbooks/authorization_url/token_set</span>
                </div>
                <div class="endpoint-body">
                    <p>Establece los tokens de acceso después de la autorización OAuth2.</p>
                    <h4>Body</h4>
                    <div class="code-block">
                        <pre><code>{
  "code": "authorization_code",
  "realmId": "realm_id",
  "state": "state_string"
}</code></pre>
                    </div>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/quickbooks/revoking_refresh_token/:sid</span>
                </div>
                <div class="endpoint-body">
                    <p>Revoca el refresh token de una conexión.</p>
                    <h4>Parámetros</h4>
                    <ul>
                        <li><code>sid</code> - ID de la conexión</li>
                    </ul>
                </div>
            </div>

            <h2 id="qb-invoices">Facturas</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/quickbooks/invoices</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene una lista de facturas de QuickBooks.</p>
                    <h4>Query Parameters</h4>
                    <ul>
                        <li><code>limit</code> - Límite de resultados (default: 100)</li>
                        <li><code>offset</code> - Offset para paginación</li>
                        <li><code>startDate</code> - Fecha de inicio (ISO 8601)</li>
                        <li><code>endDate</code> - Fecha de fin (ISO 8601)</li>
                    </ul>
                    <h4>Headers Requeridos</h4>
                    <ul>
                        <li><code>Authorization</code> - Token JWT con orgId</li>
                    </ul>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/auth/quickbooks/invoices</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene facturas con autenticación básica (para uso interno).</p>
                    <h4>Query Parameters</h4>
                    <ul>
                        <li><code>id</code> - ID de factura específica</li>
                        <li><code>docNumber</code> - Número de documento</li>
                    </ul>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/quickbooks/invoice/:invoice_sid</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene una factura específica por su ID.</p>
                    <h4>Parámetros</h4>
                    <ul>
                        <li><code>invoice_sid</code> - ID de la factura</li>
                    </ul>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/quickbooks/invoice/:invoice_id/details</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene detalles completos de una factura con minor version específica.</p>
                    <h4>Query Parameters</h4>
                    <ul>
                        <li><code>minorversion</code> - Versión de la API de QuickBooks (default: 75)</li>
                    </ul>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/quickbooks/to_emit</span>
                </div>
                <div class="endpoint-body">
                    <p>Emite una factura al PAC (Proveedor Autorizado de Certificación).</p>
                    <h4>Body</h4>
                    <div class="code-block">
                        <pre><code>{
  "invoiceId": "123",
  "organization": "org_id"
}</code></pre>
                    </div>
                    <div class="info-box warning">
                        <p>Este endpoint procesa la factura y envía al PAC panameño para obtener el CUFE.</p>
                    </div>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/quickbooks/credits_note/to_emit</span>
                </div>
                <div class="endpoint-body">
                    <p>Emite una nota de crédito al PAC.</p>
                </div>
            </div>

            <h2 id="qb-webhooks">Webhooks</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/quickbooks/event_processor</span>
                </div>
                <div class="endpoint-body">
                    <p>Procesa eventos de webhooks de QuickBooks (create, update, delete).</p>
                    <h4>Body</h4>
                    <div class="code-block">
                        <pre><code>{
  "eventNotifications": [{
    "realmId": "realm_id",
    "dataChangeEvent": {
      "entities": [{
        "name": "Invoice",
        "id": "123",
        "operation": "Create"
      }]
    }
  }]
}</code></pre>
                    </div>
                    <div class="info-box info">
                        <h4>Procesamiento Asíncrono</h4>
                        <p>Este endpoint responde inmediatamente con código 200 y procesa los eventos en segundo plano utilizando sistema de colas.</p>
                    </div>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/quickbooks/webhook_health</span>
                </div>
                <div class="endpoint-body">
                    <p>Health check para verificar el estado del procesador de eventos.</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/quickbooks/webhook_processing_config/:realm_id/:organization_id</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene la configuración de procesamiento de webhooks para una organización.</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/quickbooks/webhook_processing_config</span>
                </div>
                <div class="endpoint-body">
                    <p>Actualiza la configuración de procesamiento de webhooks.</p>
                    <h4>Body</h4>
                    <div class="code-block">
                        <pre><code>{
  "realmId": "realm_id",
  "organizationId": "org_id",
  "docucenterEnabled": true,
  "reason": "Motivo del cambio"
}</code></pre>
                    </div>
                </div>
            </div>

            <h2 id="qb-maintenance">Mantenimiento</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/quickbooks/maintenance/webhook_configs</span>
                </div>
                <div class="endpoint-body">
                    <p>Operaciones de mantenimiento para configuraciones de webhooks.</p>
                    <h4>Query Parameters</h4>
                    <ul>
                        <li><code>action</code> - Tipo de operación: report | cleanup | consolidate</li>
                        <li><code>days</code> - Días de antigüedad para cleanup (default: 90)</li>
                    </ul>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/quickbooks/maintenance/webhook_configs/full</span>
                </div>
                <div class="endpoint-body">
                    <p>Ejecuta mantenimiento completo (reporte, consolidación y limpieza).</p>
                    <h4>Body</h4>
                    <div class="code-block">
                        <pre><code>{
  "days": 90,
  "dryRun": true
}</code></pre>
                    </div>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/quickbooks/mappings/diagnostic/:connection_id</span>
                </div>
                <div class="endpoint-body">
                    <p>Diagnóstico de mappings entre QuickBooks y Docucenter.</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/quickbooks/mappings/cleanup/:connection_id</span>
                </div>
                <div class="endpoint-body">
                    <p>Limpia mappings obsoletos.</p>
                    <h4>Body</h4>
                    <div class="code-block">
                        <pre><code>{
  "dryRun": true
}</code></pre>
                    </div>
                </div>
            </div>
        </section>

        <section id="zoho" class="section">
            <h1>Zoho API</h1>
            <p>Endpoints para integración con Zoho Books y Zoho CRM.</p>

            <h2 id="zoho-auth">Autorización</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/authorization_url/:sid</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene la URL de autorización de Zoho OAuth2.</p>
                    <h4>Parámetros</h4>
                    <ul>
                        <li><code>sid</code> - ID de la conexión</li>
                    </ul>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/generate_access/:sid</span>
                </div>
                <div class="endpoint-body">
                    <p>Genera access token y refresh token desde código de autorización.</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/revoking_refresh_token/:sid</span>
                </div>
                <div class="endpoint-body">
                    <p>Revoca el refresh token de Zoho.</p>
                </div>
            </div>

            <h2 id="zoho-invoices">Facturas</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/invoices</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene lista de facturas de Zoho Books.</p>
                    <h4>Query Parameters</h4>
                    <ul>
                        <li><code>page</code> - Número de página</li>
                        <li><code>per_page</code> - Facturaspor página</li>
                        <li><code>status</code> - Estado: sent | draft | paid | void</li>
                    </ul>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/invoices/:invoice_number</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene una factura específica por su número.</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/invoices</span>
                </div>
                <div class="endpoint-body">
                    <p>Emite facturas de Zoho al PAC.</p>
                    <h4>Body</h4>
                    <div class="code-block">
                        <pre><code>{
  "invoices": ["invoice_id_1", "invoice_id_2"]
}</code></pre>
                    </div>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/invoices/:invoice_id</span>
                </div>
                <div class="endpoint-body">
                    <p>Emite una factura específica al PAC (síncrono).</p>
                    <h4>Parámetros</h4>
                    <ul>
                        <li><code>invoice_id</code> - ID de la factura en Zoho</li>
                    </ul>
                    <h4>Respuesta</h4>
                    <div class="code-block">
                        <pre><code>{
  "success": true,
  "message": "FE01234567890...",
  "automaticallyRedirect": "No"
}</code></pre>
                    </div>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/queue/invoices/:invoice_id</span>
                </div>
                <div class="endpoint-body">
                    <p>Emite una factura usando sistema de colas (asíncrono recomendado).</p>
                    <h4>Parámetros</h4>
                    <ul>
                        <li><code>invoice_id</code> - ID de la factura en Zoho</li>
                    </ul>
                    <h4>Respuesta</h4>
                    <div class="code-block">
                        <pre><code>{
  "success": true,
  "message": "Trabajo de emisión de factura en progreso.",
  "jobId": "12345",
  "invoiceId": "invoice_123",
  "automaticallyRedirect": "No"
}</code></pre>
                    </div>
                    <div class="info-box info">
                        <h4>Sistema de Colas</h4>
                        <p>Este endpoint usa Redis y Bee-Queue para procesamiento asíncrono. La factura se procesa en segundo plano con reintentos automáticos.</p>
                    </div>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/shipments</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene facturas electrónicas emitidas (shipments).</p>
                    <h4>Query Parameters</h4>
                    <ul>
                        <li><code>page</code> - Número de página</li>
                        <li><code>per_page</code> - Resultados por página</li>
                    </ul>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/credit_notes</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene lista de notas de crédito de Zoho.</p>
                </div>
            </div>

            <h2 id="zoho-credits">Notas de Crédito</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/credit_notes/:credit_number</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene una nota de crédito específica.</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/credit_notes</span>
                </div>
                <div class="endpoint-body">
                    <p>Emite notas de crédito al PAC.</p>
                </div>
            </div>
        </section>

        <section id="xero" class="section">
            <h1>Xero API</h1>
            <p>Endpoints para integración con Xero Accounting.</p>

            <h2 id="xero-auth">Autorización</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/xero/authorization_url</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene la URL de autorización de Xero OAuth2.</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/xero/authorization_url/token_set</span>
                </div>
                <div class="endpoint-body">
                    <p>Establece los tokens de acceso de Xero.</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/xero/revoking_refresh_token/:sid</span>
                </div>
                <div class="endpoint-body">
                    <p>Revoca el refresh token.</p>
                </div>
            </div>

            <h2 id="xero-invoices">Facturas</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/xero/invoices</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene facturas de Xero.</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/xero/credits_note/:credit_note</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene una nota de crédito específica.</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/xero/invoice/:invoice_sid</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene una factura específica por su ID.</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/xero/to_emit</span>
                </div>
                <div class="endpoint-body">
                    <p>Emite facturas de Xero al PAC.</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/xero/invoices/:invoice_id</span>
                </div>
                <div class="endpoint-body">
                    <p>Emite una factura específica por su ID.</p>
                    <h4>Parámetros</h4>
                    <ul>
                        <li><code>invoice_id</code> - ID de la factura en Xero</li>
                    </ul>
                    <h4>Respuesta</h4>
                    <div class="code-block">
                        <pre><code>{
  "success": true,
  "message": "FE01234567890..."
}</code></pre>
                    </div>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/auth/xero/invoices</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene facturas con autenticación básica (para uso interno).</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/auth/xero/credits_note/:credit_note</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene nota de crédito con autenticación básica.</p>
                </div>
            </div>

            <h2>Exportación de Datos</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/xero/export_json/:org_sid</span>
                </div>
                <div class="endpoint-body">
                    <p>Exporta JSON de factura para pruebas y debugging.</p>
                    <h4>Query Parameters</h4>
                    <ul>
                        <li><code>invoice_sid</code> - ID de la factura</li>
                    </ul>
                    <h4>Respuesta</h4>
                    <div class="code-block">
                        <pre><code>{
  "path": "https://storage.googleapis.com/.../12345.txt"
}</code></pre>
                    </div>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/xero/credit_note/export_json/:org_sid</span>
                </div>
                <div class="endpoint-body">
                    <p>Exporta JSON de nota de crédito.</p>
                    <h4>Query Parameters</h4>
                    <ul>
                        <li><code>invoice_sid</code> - ID de la nota de crédito</li>
                    </ul>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/xero/shipments/export_json/:org_sid</span>
                </div>
                <div class="endpoint-body">
                    <p>Exporta JSON de factura emitida (shipment).</p>
                    <h4>Query Parameters</h4>
                    <ul>
                        <li><code>invoice_sid</code> - ID de la factura emitida</li>
                    </ul>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/xero/credits_note/to_emit</span>
                </div>
                <div class="endpoint-body">
                    <p>Emite notas de crédito al PAC.</p>
                </div>
            </div>
        </section>

        <section id="shopify" class="section">
            <h1>Shopify API</h1>
            <p>Endpoints para integración con Shopify.</p>

            <h2 id="shopify-auth">Autorización</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/shopify/authorization_url</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene la URL de autorización de Shopify.</p>
                    <h4>Body</h4>
                    <div class="code-block">
                        <pre><code>{
  "shop": "tienda.myshopify.com",
  "scopes": "read_orders,write_orders"
}</code></pre>
                    </div>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/shopify/authorization_url/token_set/:sid</span>
                </div>
                <div class="endpoint-body">
                    <p>Establece el access token de Shopify.</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method put">PUT</span>
                    <span class="path">/shopify/update_client/:sid</span>
                </div>
                <div class="endpoint-body">
                    <p>Actualiza la configuración del cliente Shopify.</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/shopify/revoking_refresh_token/:sid</span>
                </div>
                <div class="endpoint-body">
                    <p>Revoca el token de acceso.</p>
                </div>
            </div>

            <h2 id="shopify-orders">Órdenes</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/shopify/orders</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene órdenes de Shopify para facturación.</p>
                    <h4>Query Parameters</h4>
                    <ul>
                        <li><code>status</code> - Estado de la orden</li>
                        <li><code>limit</code> - Límite de resultados</li>
                        <li><code>since_id</code> - ID mínimo para paginación</li>
                    </ul>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/shopify/orders/list</span>
                </div>
                <div class="endpoint-body">
                    <p>Lista de órdenes sin procesamiento adicional.</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/shopify/orders/:sid</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene una orden específica.</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/shopify/orders/refund/:sid</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene reembolsos de una orden (para notas de crédito).</p>
                </div>
            </div>

            <h2>Emisión de Facturas</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/shopify/orders/to_emit/:sid</span>
                </div>
                <div class="endpoint-body">
                    <p>Procesa emisión de factura desde webhook de Shopify (automático).</p>
                    <h4>Parámetros</h4>
                    <ul>
                        <li><code>sid</code> - ID de la organización</li>
                    </ul>
                    <h4>Respuesta</h4>
                    <div class="code-block">
                        <pre><code>{
  "success": true,
  "error": false,
  "message": "Orden emitida correctamente",
  "data": {...},
  "timestamp": "2026-02-12T10:30:00.000Z"
}</code></pre>
                    </div>
                    <div class="info-box warning">
                        <p>Este endpoint se usa típicamente como receptor de webhooks de Shopify y retorna siempre código 200 con el estado en el body.</p>
                    </div>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/shopify/orders/to_emit_manual/:sid</span>
                </div>
                <div class="endpoint-body">
                    <p>Emite factura manualmente (invocación directa).</p>
                    <h4>Parámetros</h4>
                    <ul>
                        <li><code>sid</code> - ID de la organización</li>
                    </ul>
                    <h4>Body</h4>
                    <div class="code-block">
                        <pre><code>{
  "order_id": "123456789",
  "force": false
}</code></pre>
                    </div>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/shopify/orders/credits_note/to_emit_manual/:sid</span>
                </div>
                <div class="endpoint-body">
                    <p>Emite nota de crédito manualmente desde un reembolso.</p>
                </div>
            </div>

            <h2>Webhooks</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/shopify/orders/post_webhooks/:sid</span>
                </div>
                <div class="endpoint-body">
                    <p>Lista los webhooks registrados en Shopify.</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/shopify/orders/post_webhooks</span>
                </div>
                <div class="endpoint-body">
                    <p>Registra un webhook en Shopify para notificaciones automáticas.</p>
                    <h4>Body</h4>
                    <div class="code-block">
                        <pre><code>{
  "topic": "orders/create",
  "address": "https://your-api.com/shopify/orders/to_emit/:sid",
  "format": "json"
}</code></pre>
                    </div>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/shopify/orders/post_webhooks/:sid/remove</span>
                </div>
                <div class="endpoint-body">
                    <p>Elimina un webhook registrado.</p>
                    <h4>Body</h4>
                    <div class="code-block">
                        <pre><code>{
  "webhook_id": "123456789"
}</code></pre>
                    </div>
                </div>
            </div>

            <h2>Facturas Emitidas</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/shopify/shipments</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene facturas electrónicas emitidas (shipments).</p>
                    <h4>Query Parameters</h4>
                    <ul>
                        <li><code>page</code> - Número de página</li>
                        <li><code>per_page</code> - Resultados por página</li>
                    </ul>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/shipments/export_json/:org_sid</span>
                </div>
                <div class="endpoint-body">
                    <p>Exporta JSON de factura emitida para debugging.</p>
                    <h4>Query Parameters</h4>
                    <ul>
                        <li><code>invoice_sid</code> - ID de la factura emitida</li>
                    </ul>
                </div>
            </div>
        </section>

        <section id="woocommerce" class="section">
            <h1>WooCommerce API</h1>
            <p>Endpoints para integración con WooCommerce.</p>

            <div class="info-box info">
                <p>WooCommerce utiliza autenticación mediante Consumer Key y Consumer Secret de la API REST de WooCommerce.</p>
            </div>

            <h2>Configuración</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/woo/authorization_url/token_set/:sid</span>
                </div>
                <div class="endpoint-body">
                    <p>Configura las credenciales de API de WooCommerce.</p>
                    <h4>Parámetros</h4>
                    <ul>
                        <li><code>sid</code> - ID de la conexión</li>
                    </ul>
                    <h4>Body</h4>
                    <div class="code-block">
                        <pre><code>{
  "url": "https://tienda.com",
  "consumerKey": "ck_xxxxxxxxxxxxxxxxxxxxx",
  "consumerSecret": "cs_xxxxxxxxxxxxxxxxxxxxx"
}</code></pre>
                    </div>
                </div>
            </div>

            <h2>Órdenes</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/woo/invoices</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene lista de órdenes de WooCommerce para facturación.</p>
                    <h4>Query Parameters</h4>
                    <ul>
                        <li><code>status</code> - Estado de órdenes: completed | processing | pending</li>
                        <li><code>page</code> - Número de página</li>
                        <li><code>per_page</code> - Órdenes por página</li>
                        <li><code>after</code> - Fecha de inicio (ISO 8601)</li>
                        <li><code>before</code> - Fecha de fin (ISO 8601)</li>
                    </ul>
                    <h4>Respuesta</h4>
                    <div class="code-block">
                        <pre><code>{
  "code": 0,
  "message": "success",
  "data": [...],
  "page_context": {
    "page": 1,
    "per_page": 10,
    "has_more_page": false
  }
}</code></pre>
                    </div>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/woo/invoices/:invoice_id</span>
                </div>
                <div class="endpoint-body">
                    <p>Emite una factura específica al PAC.</p>
                    <h4>Parámetros</h4>
                    <ul>
                        <li><code>invoice_id</code> - ID de la orden en WooCommerce</li>
                    </ul>
                    <h4>Respuesta</h4>
                    <div class="code-block">
                        <pre><code>{
  "success": true,
  "message": "FE01234567890...",
  "automaticallyRedirect": "No"
}</code></pre>
                    </div>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/woo/invoices/to_emit/:sid</span>
                </div>
                <div class="endpoint-body">
                    <p>Procesa emisión de factura desde webhook de WooCommerce.</p>
                    <h4>Parámetros</h4>
                    <ul>
                        <li><code>sid</code> - ID de la aplicación WooCommerce</li>
                    </ul>
                    <div class="info-box warning">
                        <p>Este endpoint se usa típicamente como receptor de webhooks de WooCommerce.</p>
                    </div>
                </div>
            </div>

            <h2>Webhooks</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/woo/invoices/post_webhooks</span>
                </div>
                <div class="endpoint-body">
                    <p>Registra un webhook en WooCommerce para notificaciones automáticas.</p>
                    <h4>Body</h4>
                    <div class="code-block">
                        <pre><code>{
  "topic": "order.created",
  "delivery_url": "https://your-api.com/woo/invoices/to_emit/:sid"
}</code></pre>
                    </div>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/woo/invoices/post_webhooks/:sid/remove</span>
                </div>
                <div class="endpoint-body">
                    <p>Elimina un webhook registrado.</p>
                    <h4>Body</h4>
                    <div class="code-block">
                        <pre><code>{
  "webhook_id": "123"
}</code></pre>
                    </div>
                </div>
            </div>

            <h2>Envíos</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/woo/shipments</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene información de envíos asociados a órdenes.</p>
                </div>
            </div>

            <h2>Exportación</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/woo/export/pdf/:cufe</span>
                </div>
                <div class="endpoint-body">
                    <p>Exporta PDF de factura emitida por su CUFE.</p>
                    <h4>Parámetros</h4>
                    <ul>
                        <li><code>cufe</code> - Código Único de Factura Electrónica</li>
                    </ul>
                    <div class="info-box info">
                        <p>Redirige automáticamente a la URL del PDF según el PAC (Docucenter, Alanube, etc.)</p>
                    </div>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/woo/export/xml/public/:cufe/:app_id</span>
                </div>
                <div class="endpoint-body">
                    <p>Exporta XML de la factura electrónica.</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/woo/export/carta/public/pdf/:cufe/:app_id</span>
                </div>
                <div class="endpoint-body">
                    <p>Genera carta de representación gráfica en PDF.</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/woo/export/cinta/public/pdf/:cufe/:app_id</span>
                </div>
                <div class="endpoint-body">
                    <p>Genera cinta de auditoría en PDF.</p>
                </div>
            </div>
        </section>

        <section id="dentalink" class="section">
            <h1>Dentalink API</h1>
            <p>Endpoints para integración con Dentalink (sistema de gestión dental).</p>

            <div class="info-box info">
                <p>Dentalink integra tratamientos dentales, pagos y pacientes para emisión de facturas electrónicas del sector salud.</p>
            </div>

            <h2>Pacientes</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/dentalink/pacientes</span>
                </div>
                <div class="endpoint-body">
                    <p>Busca pacientes en Dentalink.</p>
                    <h4>Query Parameters</h4>
                    <ul>
                        <li><code>q</code> - Término de búsqueda (nombre, RUC, etc.)</li>
                    </ul>
                    <h4>Respuesta</h4>
                    <div class="code-block">
                        <pre><code>{
  "patients": [{
    "id": "123",
    "name": "Juan Pérez",
    "ruc": "8-123-456",
    "email": "juan@example.com"
  }]
}</code></pre>
                    </div>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/dentalink/pacientes/:sid/pagos</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene los pagos de un paciente específico.</p>
                    <h4>Parámetros</h4>
                    <ul>
                        <li><code>sid</code> - ID del paciente en Dentalink</li>
                    </ul>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/dentalink/pacientes/:sid/tratamientos</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene los tratamientos de un paciente.</p>
                    <h4>Parámetros</h4>
                    <ul>
                        <li><code>sid</code> - ID del paciente</li>
                    </ul>
                    <h4>Respuesta</h4>
                    <div class="code-block">
                        <pre><code>{
  "treatments": [{
    "id": "456",
    "name": "Ortodoncia",
    "status": "active",
    "amount": 1500.00
  }]
}</code></pre>
                    </div>
                </div>
            </div>

            <h2>Facturas</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/dentalink/invoice/:relative_id</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene detalles de una factura/tratamiento por su ID relativo.</p>
                    <h4>Parámetros</h4>
                    <ul>
                        <li><code>relative_id</code> - ID relativo del tratamiento</li>
                    </ul>
                    <h4>Query Parameters</h4>
                    <ul>
                        <li><code>organization_id</code> - ID de la organización</li>
                        <li><code>payment_id</code> - IDs de pagos (separados por coma)</li>
                        <li><code>treatment_id</code> - IDs de tratamientos (separados por coma)</li>
                        <li><code>treatment_detail_id</code> - IDs de detalles (separados por coma)</li>
                    </ul>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/dentalink/invoice/:invoice_sid/payments</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene los pagos asociados a una factura/tratamiento.</p>
                    <h4>Query Parameters</h4>
                    <ul>
                        <li><code>organization_id</code> - ID de la organización</li>
                    </ul>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/dentalink/to_emit</span>
                </div>
                <div class="endpoint-body">
                    <p>Emite factura electrónica desde datos de Dentalink al PAC.</p>
                    <h4>Body</h4>
                    <div class="code-block">
                        <pre><code>{
  "patient_id": "123",
  "treatment_ids": ["456", "789"],
  "payment_ids": ["101", "102"]
}</code></pre>
                    </div>
                    <h4>Respuesta</h4>
                    <div class="code-block">
                        <pre><code>{
  "success": true,
  "cufe": "FE01234567890...",
  "transactionId": "abc123"
}</code></pre>
                    </div>
                </div>
            </div>

            <h2>Exportación</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/dentalink/shipments/export_json/:org_sid</span>
                </div>
                <div class="endpoint-body">
                    <p>Exporta JSON de factura para pruebas y debugging.</p>
                    <h4>Query Parameters</h4>
                    <ul>
                        <li><code>invoice_sid</code> - ID de la factura</li>
                    </ul>
                    <h4>Respuesta</h4>
                    <div class="code-block">
                        <pre><code>{
  "path": "https://storage.googleapis.com/.../invoice.txt"
}</code></pre>
                    </div>
                </div>
            </div>
        </section>

        <section id="utilidades" class="section">
            <h1>Utilidades y Catálogos</h1>
            <p>Endpoints para gestión de catálogos, configuraciones y datos auxiliares.</p>

            <h2>Organizaciones</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/token_organization</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene la organización asociada al token JWT.</p>
                    <h4>Headers Requeridos</h4>
                    <ul>
                        <li><code>Authorization</code> - Token JWT con orgId</li>
                    </ul>
                    <h4>Respuesta</h4>
                    <div class="code-block">
                        <pre><code>{
  "id": "org_123",
  "name": "Mi Organización",
  "ruc": "8-123-456",
  "connections": [...]  
}</code></pre>
                    </div>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/organizations/:sid</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene organizaciones asociadas a un SID específico.</p>
                    <h4>Query Parameters</h4>
                    <ul>
                        <li><code>module</code> - Módulo (quickbooks, zoho, xero, etc.)</li>
                    </ul>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/organizations/connection/:organization_id</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene conexiones asociadas a una organización.</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/save_organization_settings</span>
                </div>
                <div class="endpoint-body">
                    <p>Guarda configuración de organización incluyendo logo.</p>
                    <h4>Body (multipart/form-data)</h4>
                    <div class="code-block">
                        <pre><code>organization_id: org_123
mostrarTituloExportable: true
logo: [file]</code></pre>
                    </div>
                </div>
            </div>

            <h2>Aplicaciones</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/apps/:application</span>
                </div>
                <div class="endpoint-body">
                    <p>Lista todas las conexiones de aplicaciones por tipo.</p>
                    <h4>Parámetros</h4>
                    <ul>
                        <li><code>application</code> - quickbooks | zoho | xero | shopify | woocommerce | dentalink</li>
                    </ul>
                </div>
            </div>

            <h2>Ubicaciones y Geografía</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/locations</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene catálogo de ubicaciones fiscales de Panamá.</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/locations</span>
                </div>
                <div class="endpoint-body">
                    <p>Crea una nueva ubicación en el catálogo.</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/countries</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene catálogo de países para facturación internacional.</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/countries</span>
                </div>
                <div class="endpoint-body">
                    <p>Crea o actualiza un país en el catálogo.</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/countries/:country_id</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene un país específico por su ID.</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/countries/:country_code/by_code</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene un país por su código ISO (ej: PA, US, ES).</p>
                </div>
            </div>

            <h2>Catálogos Fiscales</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/units</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene catálogo de unidades de medida fiscales.</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/delivery_conditions</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene catálogo de condiciones de entrega (Incoterms).</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/coins</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene catálogo de monedas para facturación multi-moneda.</p>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/coins</span>
                </div>
                <div class="endpoint-body">
                    <p>Crea o actualiza una moneda en el catálogo.</p>
                </div>
            </div>

            <h2>Exportación de Archivos</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/export/xml/:cufe</span>
                </div>
                <div class="endpoint-body">
                    <p>Exporta el XML de una factura electrónica por su CUFE.</p>
                    <h4>Parámetros</h4>
                    <ul>
                        <li><code>cufe</code> - Código Único de Factura Electrónica</li>
                    </ul>
                    <div class="info-box info">
                        <p>Descarga directa de archivo XML.</p>
                    </div>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/export/pdf/:cufe</span>
                </div>
                <div class="endpoint-body">
                    <p>Redirige al PDF de la factura electrónica según el PAC.</p>
                    <h4>Parámetros</h4>
                    <ul>
                        <li><code>cufe</code> - Código Único de Factura Electrónica</li>
                    </ul>
                    <div class="info-box info">
                        <p>Redirige automáticamente según el PAC: Docucenter, Alanube, Digifact, etc.</p>
                    </div>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/send_invoice/:cufe</span>
                </div>
                <div class="endpoint-body">
                    <p>Envía comprobante de factura por email al cliente.</p>
                    <h4>Body</h4>
                    <div class="code-block">
                        <pre><code>{
  "organization_id": "org_123"
}</code></pre>
                    </div>
                </div>
            </div>

            <h2>Usuario</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/user</span>
                </div>
                <div class="endpoint-body">
                    <p>Obtiene información del usuario autenticado desde el token JWT.</p>
                    <h4>Respuesta</h4>
                    <div class="code-block">
                        <pre><code>{
  "userId": "user_123",
  "email": "usuario@example.com",
  "admin": false
}</code></pre>
                    </div>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/user_by_email</span>
                </div>
                <div class="endpoint-body">
                    <p>Búsqueda de usuario por email (solo para administradores).</p>
                    <h4>Query Parameters</h4>
                    <ul>
                        <li><code>email</code> - Email del usuario a buscar</li>
                    </ul>
                </div>
            </div>
        </section>

        <section id="administracion" class="section">
            <h1>Administración QuickBooks</h1>
            <p>Endpoints para gestión avanzada de clientes, facturas y sincronización con QuickBooks.</p>

            <div class="info-box warning">
                <h4>Endpoints Especializados</h4>
                <p>Estos endpoints están diseñados para operaciones administrativas y correcciones de datos. Usan reintentos automáticos y manejo robusto de errores.</p>
            </div>

            <h2>Gestión de Clientes</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/create_client_quickbooks</span>
                </div>
                <div class="endpoint-body">
                    <p>Crea un nuevo cliente en QuickBooks con reintentos automáticos.</p>
                    <h4>Body</h4>
                    <div class="code-block">
                        <pre><code>{
  "connection_id": "conn_123",
  "Nombre": "Juan Pérez",
  "CompanyName": "Empresa ABC",
  "PrimaryEmailAddr": {
    "Address": "juan@example.com"
  },
  "BillAddr": {
    "Line1": "Calle Principal",
    "City": "Ciudad de Panamá",
    "Country": "PA"
  },
  "PrimaryPhone": {
    "FreeFormNumber": "+507 1234-5678"
  }
}</code></pre>
                    </div>
                    <h4>Respuesta</h4>
                    <div class="code-block">
                        <pre><code>{
  "success": true,
  "message": "Cliente creado exitosamente",
  "data": {
    "Id": "456",
    "DisplayName": "Juan Pérez",
    "PrimaryEmailAddr": {...}
  },
  "timestamp": "2026-02-12T10:30:00.000Z"
}</code></pre>
                    </div>
                    <div class="info-box info">
                        <p>Sistema de reintentos: hasta 3 intentos con backoff exponencial para rate limits y errores temporales.</p>
                    </div>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/verify_and_sync_customer_quickbooks</span>
                </div>
                <div class="endpoint-body">
                    <p>Verifica si un cliente existe en QuickBooks y lo sincroniza o crea.</p>
                    <h4>Body</h4>
                    <div class="code-block">
                        <pre><code>{
  "connection_id": "conn_123",
  "Id": "customer_local_id",
  "Nombre": "Juan Pérez",
  "Email": "juan@example.com"
}</code></pre>
                    </div>
                    <h4>Respuesta</h4>
                    <div class="code-block">
                        <pre><code>{
  "success": true,
  "message": "Cliente verificado/sincronizado",
  "data": {...},
  "timestamp": "2026-02-12T10:30:00.000Z"
}</code></pre>
                    </div>
                </div>
            </div>

            <h2>Gestión de Facturas</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="path">/create_invoice_quickbooks</span>
                </div>
                <div class="endpoint-body">
                    <p>Crea una factura en QuickBooks desde datos externos (ej: Docucenter).</p>
                    <h4>Body</h4>
                    <div class="code-block">
                        <pre><code>{
  "connection_id": "conn_123",
  "CustomerRef": "customer_qb_id",
  "CustomerName": "Juan Pérez",
  "NumeroFactura": "001-001-00001234",
  "Fecha": "2026-02-12",
  "TotalAmt": 150.00,
  "Line": [
    {
      "Amount": 150.00,
      "DetailType": "SalesItemLineDetail",
      "SalesItemLineDetail": {
        "ItemRef": {"value": "1"},
        "Qty": 1,
        "UnitPrice": 150.00,
        "TaxCodeRef": {"value": "TAX"}
      }
    }
  ]
}</code></pre>
                    </div>
                    <div class="info-box warning">
                        <h4>Diagnóstico Automático</h4>
                        <p>Este endpoint incluye logging detallado para debug de mappings de clientes y validación de datos.</p>
                    </div>
                </div>
            </div>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method put">PUT</span>
                    <span class="path">/fix_invoice_and_payment_customer/:invoice_id</span>
                </div>
                <div class="endpoint-body">
                    <p>Corrige el cliente de una factura y su payment asociado en QuickBooks.</p>
                    <h4>Parámetros</h4>
                    <ul>
                        <li><code>invoice_id</code> - ID de la factura en QuickBooks</li>
                    </ul>
                    <h4>Query Parameters</h4>
                    <ul>
                        <li><code>minorversion</code> - Versión de API (default: 75)</li>
                    </ul>
                    <h4>Body</h4>
                    <div class="code-block">
                        <pre><code>{
  "connection_id": "conn_123",
  "customer_id": "nuevo_customer_qb_id"
}</code></pre>
                    </div>
                    <h4>Proceso</h4>
                    <ol>
                        <li>Actualiza el CustomerRef de la factura</li>
                        <li>Busca el Payment asociado</li>
                        <li>Si existe, elimina el Payment antiguo</li>
                        <li>Crea nuevo Payment con el cliente correcto</li>
                    </ol>
                    <div class="info-box danger">
                        <h4>Operación Crítica</h4>
                        <p>Este endpoint elimina y recrea Payments. Usar con precaución y verificar resultados.</p>
                    </div>
                </div>
            </div>

            <h2>Exportación JSON (Debugging)</h2>

            <div class="endpoint">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="path">/quickbooks/export_json</span>
                </div>
                <div class="endpoint-body">
                    <p>Exporta JSON de factura de QuickBooks para debugging.</p>
                    <h4>Query Parameters</h4>
                    <ul>
                        <li><code>id</code> - ID de la factura en QuickBooks</li>
                    </ul>
                    <h4>Respuesta</h4>
                    <div class="code-block">
                        <pre><code>{
  "path": "https://storage.googleapis.com/.../invoice.txt"
}</code></pre>
                    </div>
                </div>
            </div>
        </section>

        <section id="errores" class="section">
            <h1>Códigos de Respuesta y Errores</h1>
            
            <h2>Códigos HTTP</h2>
            <div class="info-box info">
                <p>La API utiliza códigos de estado HTTP estándar para indicar éxito o fallo de las peticiones.</p>
            </div>

            <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                <thead>
                    <tr style="background-color: var(--hover-bg); border-bottom: 2px solid var(--border-color);">
                        <th style="padding: 12px; text-align: left;">Código</th>
                        <th style="padding: 12px; text-align: left;">Significado</th>
                        <th style="padding: 12px; text-align: left;">Descripción</th>
                    </tr>
                </thead>
                <tbody>
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td style="padding: 12px;"><code>200</code></td>
                        <td style="padding: 12px;">OK</td>
                        <td style="padding: 12px;">Petición exitosa</td>
                    </tr>
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td style="padding: 12px;"><code>201</code></td>
                        <td style="padding: 12px;">Created</td>
                        <td style="padding: 12px;">Recurso creado exitosamente</td>
                    </tr>
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td style="padding: 12px;"><code>400</code></td>
                        <td style="padding: 12px;">Bad Request</td>
                        <td style="padding: 12px;">Parámetros inválidos o faltantes</td>
                    </tr>
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td style="padding: 12px;"><code>401</code></td>
                        <td style="padding: 12px;">Unauthorized</td>
                        <td style="padding: 12px;">Autenticación inválida o token expirado</td>
                    </tr>
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td style="padding: 12px;"><code>404</code></td>
                        <td style="padding: 12px;">Not Found</td>
                        <td style="padding: 12px;">Recurso no encontrado</td>
                    </tr>
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td style="padding: 12px;"><code>422</code></td>
                        <td style="padding: 12px;">Unprocessable Entity</td>
                        <td style="padding: 12px;">Error de validación o procesamiento</td>
                    </tr>
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td style="padding: 12px;"><code>500</code></td>
                        <td style="padding: 12px;">Internal Server Error</td>
                        <td style="padding: 12px;">Error interno del servidor</td>
                    </tr>
                </tbody>
            </table>

            <h2>Formato de Errores</h2>
            <p>Los errores se devuelven en formato JSON con la siguiente estructura:</p>
            <div class="code-block">
                <pre><code>{
  "error": {
    "message": "Descripción del error",
    "code": "ERROR_CODE",
    "details": {
      "field": "campo_con_error",
      "reason": "explicación específica"
    }
  }
}</code></pre>
            </div>

            <h2>Errores Comunes</h2>

            <div class="info-box danger">
                <h4>Token Expirado</h4>
                <div class="code-block">
                    <pre><code>{
  "error": {
    "message": "Token has expired",
    "code": "TOKEN_EXPIRED"
  }
}</code></pre>
                </div>
                <p><strong>Solución:</strong> Renovar el access token usando el refresh token correspondiente.</p>
            </div>

            <div class="info-box danger">
                <h4>RUC Inválido</h4>
                <div class="code-block">
                    <pre><code>{
  "error": {
    "message": "RUC inválido detectado (0-0-0)",
    "code": "INVALID_RUC"
  }
}</code></pre>
                </div>
                <p><strong>Solución:</strong> Verificar que el cliente tenga un RUC válido en la plataforma de origen.</p>
            </div>

            <div class="info-box danger">
                <h4>Factura Ya Emitida</h4>
                <div class="code-block">
                    <pre><code>{
  "skipped": true,
  "reason": "already_emitted",
  "cufe": "FE01234567890...",
  "message": "Factura ya fue emitida al PAC"
}</code></pre>
                </div>
                <p><strong>Solución:</strong> La factura ya tiene CUFE, no se puede reemitir. Este no es un error, es un estado informativo.</p>
            </div>

            <div class="info-box warning">
                <h4>Rate Limit</h4>
                <p>Si se excede el límite de peticiones, se recibirá un error 429. El sistema implementa reintentos automáticos con backoff exponencial.</p>
            </div>

            <h2>Respuestas Exitosas</h2>

            <h3>Factura Emitida</h3>
            <div class="code-block">
                <pre><code>{
  "success": true,
  "cufe": "FE0123456789012345678901234567890123456789012345",
  "transactionId": "abc123def456",
  "docNumber": "001-001-00001234",
  "pdfUrl": "https://api.pac.com/pdf/...",
  "xmlUrl": "https://api.pac.com/xml/..."
}</code></pre>
            </div>

            <h3>Lista de Facturas</h3>
            <div class="code-block">
                <pre><code>{
  "code": 0,
  "message": "success",
  "data": [
    {
      "id": "123",
      "docNumber": "001-001-00001234",
      "customer": {...},
      "total": 150.00,
      "cufe": "FE01234567..."
    }
  ],
  "page_context": {
    "page": 1,
    "per_page": 10,
    "has_more_page": true
  }
}</code></pre>
            </div>

            <h2>Reintentos y Recuperación</h2>
            <div class="info-box info">
                <h4>Sistema de Reintentos</h4>
                <p>La API implementa reintentos automáticos para operaciones críticas:</p>
                <ul>
                    <li><strong>Facturas:</strong> Hasta 8 intentos con backoff exponencial</li>
                    <li><strong>Webhooks:</strong> Hasta 5 intentos con delays incrementales</li>
                    <li><strong>Tokens:</strong> Renovación automática en errores 401</li>
                    <li><strong>Rate Limits:</strong> Espera inteligente según tipo de error</li>
                </ul>
            </div>
        </section>

        <section id="mejores-practicas" class="section">
            <h1>Mejores Prácticas</h1>

            <h2>Workflows Comunes</h2>

            <h3>1. Configuración Inicial de Integración</h3>
            <div class="code-block">
                <pre><code>// Paso 1: Obtener URL de autorización
GET /quickbooks/authorization_url
// o para Zoho
GET /authorization_url/:sid

// Paso 2: Usuario autoriza en plataforma
// (redirigir al authUri recibido)

// Paso 3: Establecer tokens
POST /quickbooks/authorization_url/token_set
{
  "code": "authorization_code",
  "realmId": "realm_id"
}

// Paso 4: Verificar conexión
GET /quickbooks/invoices?limit=1</code></pre>
            </div>

            <h3>2. Emisión de Factura (Recomendado)</h3>
            <div class="info-box info">
                <h4>Usar Sistema de Colas para Mayor Confiabilidad</h4>
                <p>Para Zoho, se recomienda usar el endpoint con cola:</p>
            </div>
            <div class="code-block">
                <pre><code>// QuickBooks (procesamiento asíncrono automático vía webhook)
// Las facturas se procesan automáticamente cuando llegan webhooks

// Zoho (usar cola para asíncrono)
POST /queue/invoices/:invoice_id
{
  "organization_id": "org_123"
}

// Respuesta inmediata con job ID
{
  "success": true,
  "jobId": "12345",
  "message": "Trabajo de emisión de factura en progreso."
}

// Shopify/WooCommerce (webhook automático)
// Configurar webhook que apunte a:
POST /shopify/orders/to_emit/:sid
POST /woo/invoices/to_emit/:sid</code></pre>
            </div>

            <h3>3. Verificación de Factura Emitida</h3>
            <div class="code-block">
                <pre><code>// Obtener factura con CUFE
GET /quickbooks/invoice/:invoice_id/details?minorversion=75

// Verificar en PrivateNote
{
  "Invoice": {
    "Id": "123",
    "DocNumber": "001-001-00001234",
    "PrivateNote": "CUFE: FE01234567890..."
  }
}

// Si no tiene CUFE, emitir
POST /quickbooks/to_emit
{
  "invoiceId": "123",
  "organization": "org_id"
}</code></pre>
            </div>

            <h2>Manejo de Webhooks</h2>

            <h3>QuickBooks Webhooks</h3>
            <div class="code-block">
                <pre><code>// Configurar endpoint en QuickBooks Developer Dashboard:
URL: https://your-api.com/quickbooks/event_processor

// Payload recibido:
{
  "eventNotifications": [{
    "realmId": "123456789",
    "dataChangeEvent": {
      "entities": [{
        "name": "Invoice",
        "id": "456",
        "operation": "Create"
      }]
    }
  }]
}

// Respuesta inmediata (< 3 segundos)
{
  "success": true,
  "webhookId": "webhook_abc123",
  "processing": "En progreso en segundo plano"
}</code></pre>
            </div>

            <h3>Shopify/WooCommerce Webhooks</h3>
            <div class="code-block">
                <pre><code>// Registrar webhook
POST /shopify/orders/post_webhooks
{
  "topic": "orders/create",
  "address": "https://your-api.com/shopify/orders/to_emit/:sid"
}

// Listar webhooks activos
GET /shopify/orders/post_webhooks/:sid

// Eliminar webhook
POST /shopify/orders/post_webhooks/:sid/remove
{
  "webhook_id": "123456789"
}</code></pre>
            </div>

            <h2>Optimizaciones y Consideraciones</h2>

            <div class="info-box warning">
                <h4>Rate Limits</h4>
                <ul>
                    <li><strong>QuickBooks:</strong> 500 peticiones/minuto por realmId</li>
                    <li><strong>Zoho:</strong> 200 peticiones/minuto</li>
                    <li><strong>Xero:</strong> 60 peticiones/minuto</li>
                    <li><strong>Shopify:</strong> 2 peticiones/segundo por tienda</li>
                </ul>
                <p>La API implementa reintentos automáticos con backoff exponencial.</p>
            </div>

            <div class="info-box info">
                <h4>Validaciones Automáticas</h4>
                <p>La API realiza las siguientes validaciones antes de emitir:</p>
                <ul>
                    <li>RUC válido (no 0-0-0 ni valores placeholder)</li>
                    <li>Verificación de CUFE existente (evita duplicados)</li>
                    <li>Tax codes válidos (ITBMS0, ITBMS7, ITBMS10, ITBMS15)</li>
                    <li>Datos de cliente completos</li>
                    <li>Tipo de receptor (nacional 01-02-03 o extranjero 04)</li>
                </ul>
            </div>

            <h2>Debugging y Troubleshooting</h2>

            <h3>Exportar JSON para Debugging</h3>
            <div class="code-block">
                <pre><code>// QuickBooks
GET /quickbooks/export_json?id=:invoice_id

// Zoho/Xero/Shopify/WooCommerce/Dentalink
GET /xero/export_json/:org_sid?invoice_sid=:id
GET /shopify/shipments/export_json/:org_sid?invoice_sid=:id
GET /woo/export_json/:app_id
GET /dentalink/shipments/export_json/:org_sid?invoice_sid=:id

// Respuesta
{
  "path": "https://storage.googleapis.com/.../invoice.txt"
}</code></pre>
            </div>

            <h3>Verificar Configuración de Webhooks</h3>
            <div class="code-block">
                <pre><code>// QuickBooks - Health check
GET /quickbooks/webhook_health

// QuickBooks - Configuración por organización
GET /quickbooks/webhook_processing_config/:realm_id/:organization_id

// QuickBooks - Actualizar configuración
POST /quickbooks/webhook_processing_config
{
  "realmId": "123",
  "organizationId": "org_456",
  "docucenterEnabled": true,
  "reason": "Habilitar procesamiento automático"
}</code></pre>
            </div>

            <h3>Mantenimiento de Mappings</h3>
            <div class="code-block">
                <pre><code>// Diagnóstico de mappings
GET /quickbooks/mappings/diagnostic/:connection_id

// Limpieza de mappings obsoletos (dry run)
POST /quickbooks/mappings/cleanup/:connection_id
{
  "dryRun": true
}

// Ejecutar limpieza real
POST /quickbooks/mappings/cleanup/:connection_id
{
  "dryRun": false
}</code></pre>
            </div>

            <h2>Seguridad y Autenticación</h2>

            <div class="info-box danger">
                <h4>Protección de Credenciales</h4>
                <ul>
                    <li>Nunca exponer tokens en logs o respuestas de error</li>
                    <li>Usar HTTPS para todas las peticiones</li>
                    <li>Rotar refresh tokens periódicamente</li>
                    <li>Implementar validación de signatures en webhooks (cuando disponible)</li>
                    <li>Almacenar tokens encriptados en Firestore</li>
                </ul>
            </div>

            <div class="info-box info">
                <h4>Renovación Automática de Tokens</h4>
                <p>La API maneja automáticamente la renovación de tokens:</p>
                <ul>
                    <li>Detecta errores 401 y renueva el access token</li>
                    <li>Usa refresh token para obtener nuevo access token</li>
                    <li>Reintentos automáticos después de renovación</li>
                    <li>Actualiza tokens en Firestore para persistencia</li>
                </ul>
            </div>

            <h2>Monitoreo y Logs</h2>

            <h3>Logs Estructurados</h3>
            <p>Los logs de la API incluyen:</p>
            <div class="code-block">
                <pre><code>// Formato de log típico
[QUICKBOOKS] [realm_id] Procesando factura 123 - Intento 1/8
[QUICKBOOKS] [realm_id] RUC: 8-123-456, DV: 78, TIPO: 01
[QUICKBOOKS] [realm_id] Factura 123 procesada exitosamente
[QUICKBOOKS] [realm_id] CUFE: FE01234567890...

// Logs de webhook
WEBHOOK webhook_abc123: Iniciando procesamiento
WEBHOOK webhook_abc123: 3 eventos recibidos
WEBHOOK webhook_abc123: Procesamiento exitoso - 3/3 procesados</code></pre>
            </div>

            <h3>Eventos en Cola</h3>
            <div class="code-block">
                <pre><code>// Ver eventos pausados
GET /quickbooks/paused_webhook_events/:realm_id?organization_id=:org_id

// Reprocesar eventos pausados
POST /quickbooks/reprocess_paused_events/:realm_id
{
  "eventIds": ["event_1", "event_2"]
}</code></pre>
            </div>

            <h2>Arquitectura y Escalabilidad</h2>

            <div class="info-box info">
                <h4>Sistema de Colas (Redis + Bee-Queue)</h4>
                <p>Para operaciones de larga duración:</p>
                <ul>
                    <li><strong>Zoho Invoices:</strong> Cola dedicada con procesador centralizado</li>
                    <li><strong>Zoho Credit Notes:</strong> Cola separada para notas de crédito</li>
                    <li><strong>QuickBooks Webhooks:</strong> Procesamiento en segundo plano</li>
                    <li><strong>Reintentos:</strong> Hasta 3 intentos por job con backoff exponencial</li>
                    <li><strong>Failed Jobs:</strong> Almacenados en Redis para análisis</li>
                </ul>
            </div>

            <div class="info-box info">
                <h4>Firebase Functions</h4>
                <ul>
                    <li><strong>Region:</strong> us-central1</li>
                    <li><strong>Timeout:</strong> 540 segundos (9 minutos)</li>
                    <li><strong>Memory:</strong> 1GB</li>
                    <li><strong>Runtime:</strong> Node.js 20+</li>
                </ul>
            </div>
        </section>
    </main>

    <script src="script.js"></script>
</body>
</html>
